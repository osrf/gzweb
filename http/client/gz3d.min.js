var GZ3D=GZ3D||{REVISION:"1"},GAZEBO_MODEL_DATABASE_URI="http://gazebosim.org/models";GZ3D.GZIface=function(a){this.scene=a,this.init()},GZ3D.GZIface.prototype.init=function(){this.material=[],this.webSocket=new ROSLIB.Ros({url:"ws://"+location.hostname+":7681"}),this.heartbeatTopic=new ROSLIB.Topic({ros:this.webSocket,name:"~/heartbeat",messageType:"heartbeat"});var a=this,b=function(){var b={alive:1};a.heartbeatTopic.publish(b)};setInterval(b,5e3);var c=new ROSLIB.Topic({ros:this.webSocket,name:"~/material",messageType:"material"}),d=function(a){this.material=a};c.subscribe(d.bind(this)),this.sceneTopic=new ROSLIB.Topic({ros:this.webSocket,name:"~/scene",messageType:"scene"});var e=function(a){a.grid===!0&&this.scene.createGrid();for(var b=0;b<a.light.length;++b){var c=a.light[b],d=this.createLightFromMsg(c);this.scene.add(d)}for(var e=0;e<a.model.length;++e){var f=a.model[e],g=this.createModelFromMsg(f);this.scene.add(g)}this.sceneTopic.unsubscribe()};this.sceneTopic.subscribe(e.bind(this));var f=new ROSLIB.Topic({ros:this.webSocket,name:"~/pose/info",messageType:"pose"}),g=function(a){var b=this.scene.getByName(a.name);b&&this.scene.updatePose(b,a.position,a.orientation)};f.subscribe(g.bind(this));var h=new ROSLIB.Topic({ros:this.webSocket,name:"~/request",messageType:"request"}),i=function(a){if("entity_delete"===a.request){var b=this.scene.getByName(a.data);b&&this.scene.remove(b)}};h.subscribe(i.bind(this));var j=new ROSLIB.Topic({ros:this.webSocket,name:"~/model/info",messageType:"model"}),k=function(a){var b=this.createModelFromMsg(a);this.scene.add(b)};j.subscribe(k.bind(this));var l=new ROSLIB.Topic({ros:this.webSocket,name:"~/light",messageType:"light"}),m=function(a){var b=this.createLightFromMsg(a);this.scene.add(b)};l.subscribe(m.bind(this)),this.modelModifyTopic=new ROSLIB.Topic({ros:this.webSocket,name:"~/model/modify",messageType:"model"});var n=function(b){var c=b.matrixWorld,d=new THREE.Vector3,e=new THREE.Quaternion,f=new THREE.Vector3;c.decompose(d,e,f);var g={name:b.name,id:b.userData,position:{x:d.x,y:d.y,z:d.z},orientation:{w:e.w,x:e.x,y:e.y,z:e.z}};a.modelModifyTopic.publish(g)};this.scene.emitter.on("poseChanged",n)},GZ3D.GZIface.prototype.createModelFromMsg=function(a){var b=new THREE.Object3D;b.name=a.name,b.userData=a.id,a.pose&&this.scene.setPose(b,a.pose.position,a.pose.orientation);for(var c=0;c<a.link.length;++c){var d=a.link[c],e=new THREE.Object3D;e.name=d.name,e.userData=d.id,d.pose&&this.scene.setPose(e,d.pose.position,d.pose.orientation),b.add(e);for(var f=0;f<d.visual.length;++f){var g=d.visual[f];if(g.geometry){var h=g.geometry,i=new THREE.Object3D;i.name=g.name,g.pose&&this.scene.setPose(i,g.pose.position,g.pose.orientation),this.createGeom(h,g.material,i),i.castShadow=!0,e.add(i)}}}return b},GZ3D.GZIface.prototype.createLightFromMsg=function(a){var b,c="rgb("+255*a.diffuse.r+","+255*a.diffuse.g+","+255*a.diffuse.b+")";return 1===a.type&&(b=new THREE.PointLight(c),b.distance=a.range),2===a.type?(b=new THREE.SpotLight(c),b.distance=a.range):3===a.type&&(b=new THREE.DirectionalLight(c)),b.castShadow=a.cast_shadows,a.pose&&this.scene.setPose(b,a.pose.position,a.pose.orientation),b.name=a.name,b},GZ3D.GZIface.prototype.createGeom=function(a,b,c){var d,e,f="assets";if(b){var g=b.script;if(g&&g.uri.length>0&&g.name){var h=this.material[g.name];if(h){for(var i,j=0;j<g.uri.length;++j)if(g.uri[j].indexOf("textures")>0){i=g.uri[j].substring(g.uri[j].indexOf("://")+3);break}i&&(e=f+"/"+i+"/"+h)}}}if(a.box)d=this.scene.createBox(a.box.size.x,a.box.size.y,a.box.size.z);else if(a.cylinder)d=this.scene.createCylinder(a.cylinder.radius,a.cylinder.length);else if(a.sphere)d=this.scene.createSphere(a.sphere.radius);else if(a.mesh){for(var k=c;k.parent;)k=k.parent;var l=a.mesh.filename,m=a.mesh.submesh,n=a.mesh.center_submesh;console.log(a.mesh.filename+" "+m);var o=l.substring(0,l.indexOf("://"));if("file"===o||"model"===o){var p=l.substring(l.indexOf("://")+3);a.mesh.scale&&(c.scale.x=a.mesh.scale.x,c.scale.y=a.mesh.scale.y,c.scale.z=a.mesh.scale.z),this.scene.loadMesh(f+"/"+p,m,n,e,c)}}d&&(e&&(d.material=new THREE.MeshPhongMaterial({map:THREE.ImageUtils.loadTexture(e)})),d.updateMatrix(),c.add(d))},GZ3D.Scene=function(){this.init()},GZ3D.Scene.prototype.init=function(){this.scene=new THREE.Scene,this.scene.name="scene",this.meshes={},this.selectedEntity=null,this.mouseEntity=null,this.renderer=new THREE.WebGLRenderer({antialias:!1}),this.renderer.setClearColor(13421772,1),this.renderer.setSize(window.innerWidth,window.innerHeight);var a=new THREE.AmbientLight(2236962);this.scene.add(a),this.camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.1,1e3),this.camera.position.x=0,this.camera.position.y=-5,this.camera.position.z=5,this.camera.up=new THREE.Vector3(0,0,1),this.camera.lookAt(0,0,0);var b=this;this.getDomElement().addEventListener("mousedown",function(a){b.onMouseDown(a)},!1),this.getDomElement().addEventListener("mouseup",function(a){b.onMouseUp(a)},!1),this.modelManipulator=new THREE.TransformControls(this.camera,this.getDomElement()),this.controls=new THREE.TrackballControls(this.camera),this.controls.rotateSpeed=1,this.controls.zoomSpeed=1.2,this.controls.panSpeed=.8,this.controls.noZoom=!1,this.controls.noPan=!1,this.controls.staticMoving=!0,this.controls.dynamicDampingFactor=.3,this.controls.keys=[65,83,68],this.emitter=new EventEmitter2({verbose:!0}),this.iface=new GZ3D.GZIface(this)},GZ3D.Scene.prototype.onMouseDown=function(a){a.preventDefault();var b=new THREE.Projector,c=new THREE.Vector3(2*(a.clientX/window.innerWidth)-1,2*-(a.clientY/window.innerHeight)+1,.5);b.unprojectVector(c,this.camera);var d=new THREE.Raycaster(this.camera.position,c.sub(this.camera.position).normalize()),e=[];this.scene.getDescendants(e);var f=d.intersectObjects(e);if(f.length>0){for(var g,h=0;h<f.length;++h){if(g=f[h].object,!this.modelManipulator.hovered&&"grid"===f[h].object.name)return this.killCameraControl=!1,void 0;for(;g.parent!==this.scene;)g=g.parent;if(this.modelManipulator.hovered){if(g===this.modelManipulator.gizmo)break}else if(""!==g.name)break}g?(console.log("found model "+g.name+" "+f.length),""!==g.name?(console.log("attached"),this.modelManipulator.attach(g),this.selectedEntity=g,this.mouseEntity=this.selectedEntity,this.scene.add(this.modelManipulator.gizmo),this.killCameraControl=!0):this.modelManipulator.hovered?(console.log("hovered "+this.modelManipulator.object.name),this.modelManipulator.update(),this.modelManipulator.object.updateMatrixWorld(),this.mouseEntity=this.selectedEntity,this.killCameraControl=!0):this.killCameraControl=!1):(console.log("detached"),this.modelManipulator.detach(),this.scene.remove(this.modelManipulator.gizmo),this.killCameraControl=!1,this.selectedEntity=null)}},GZ3D.Scene.prototype.onMouseUp=function(a){a.preventDefault(),this.modelManipulator.hovered&&this.selectedEntity?this.emitter.emit("poseChanged",this.modelManipulator.object):this.killCameraControl&&(this.killCameraControl=!1),this.mouseEntity=null},GZ3D.Scene.prototype.getDomElement=function(){return this.renderer.domElement},GZ3D.Scene.prototype.render=function(){this.killCameraControl||this.controls.update(),this.modelManipulator.update(),this.renderer.render(this.scene,this.camera)},GZ3D.Scene.prototype.setWindowSize=function(a,b){this.camera.aspect=a/b,this.camera.updateProjectionMatrix(),this.renderer.setSize(a,b),this.controls.handleResize(),this.render()},GZ3D.Scene.prototype.add=function(a){this.scene.add(a)},GZ3D.Scene.prototype.remove=function(a){this.scene.remove(a)},GZ3D.Scene.prototype.getByName=function(a){return this.scene.getObjectByName(a,!0)},GZ3D.Scene.prototype.updatePose=function(a,b,c){this.modelManipulator&&this.modelManipulator.object&&this.modelManipulator.hovered&&this.mouseEntity||this.setPose(a,b,c)},GZ3D.Scene.prototype.setPose=function(a,b,c){a.position.x=b.x,a.position.y=b.y,a.position.z=b.z,a.quaternion.w=c.w,a.quaternion.x=c.x,a.quaternion.y=c.y,a.quaternion.z=c.z},GZ3D.Scene.prototype.createGrid=function(){var a=new THREE.GridHelper(10,1);a.name="grid",a.rotation.x=.5*Math.PI,this.scene.add(a)},GZ3D.Scene.prototype.createSphere=function(a){var b=new THREE.SphereGeometry(a,32,32),c=new THREE.MeshPhongMaterial({color:16777215,shading:THREE.SmoothShading}),d=new THREE.Mesh(b,c);return d},GZ3D.Scene.prototype.createCylinder=function(a,b){var c=new THREE.CylinderGeometry(a,a,b,32,1,!1),d=new THREE.MeshPhongMaterial({color:16777215,shading:THREE.SmoothShading}),e=new THREE.Mesh(c,d);return e.rotation.x=.5*Math.PI,e},GZ3D.Scene.prototype.createBox=function(a,b,c){var d=new THREE.CubeGeometry(a,b,c,1,1,1),e=new THREE.MeshPhongMaterial({color:16777215,shading:THREE.SmoothShading}),f=new THREE.Mesh(d,e);return f},GZ3D.Scene.prototype.loadMesh=function(a,b,c,d,e){var f=a.substring(0,a.lastIndexOf("/")),g=a.substring(a.lastIndexOf("/")+1);if(".dae"===g.substr(-4).toLowerCase())return this.loadCollada(a,b,c,d,e);if(".urdf"===g.substr(-5).toLowerCase()){var h=new ROSLIB.UrdfModel({string:a}),i=h.links;for(var j in i){var k=i[j];if(k.visual&&k.visual.geometry&&k.visual.geometry.type===ROSLIB.URDF_MESH){"/"+k.name;var l=k.visual.geometry.filename,m=l.substr(-4).toLowerCase(),n=l.substring(l.indexOf("://")+3);if(".dae"===m){var o=this.loadCollada(f+"/"+n,e);k.visual.geometry.scale&&(o.scale=new THREE.Vector3(k.visual.geometry.scale.x,k.visual.geometry.scale.y,k.visual.geometry.scale.z))}}}}},GZ3D.Scene.prototype.loadCollada=function(a,b,c,d,e){var f;this.meshes[a]&&(f=this.meshes[a],b&&console.log(" sub returned "+b));var g=new THREE.ColladaLoader,h=a,i=b,j=c;g.load(a,function(a){f=a.scene,f.updateMatrix(),this.scene.meshes[h]=f;var b,c=[];f.getDescendants(c);for(var g=0;g<c.length;++g)if(c[g]instanceof THREE.Mesh){if(i||b||(b=c[g]),i)if(c[g].geometry.name===i){if(j){var k=c[g].geometry.vertices,l=new THREE.Vector3,m=new THREE.Vector3;l.x=k[0].x,l.y=k[0].y,l.z=k[0].z,m.x=l.x,m.y=l.y,m.z=l.z;for(var n=1;n<k.length;++n)l.x=Math.min(l.x,k[n].x),l.y=Math.min(l.y,k[n].y),l.z=Math.min(l.z,k[n].z),m.x=Math.max(m.x,k[n].x),m.y=Math.max(m.y,k[n].y),m.z=Math.max(m.z,k[n].z);var o=new THREE.Vector3;c[g].parent.position.x+=o.x,c[g].parent.position.y+=o.y,c[g].parent.position.z+=o.z}b=c[g],console.log("mesh "+c[g].geometry.name+" "+b.position.x+" "+b.position.y+" "+b.position.z),console.log("parent "+c[g].geometry.name+" "+b.parent.position.x+" "+b.parent.position.y+" "+b.parent.position.z)}else c[g].parent.remove(c[g])}else c[g]instanceof THREE.AmbientLight&&c[g].parent.remove(c[g]);if(d){var p=new THREE.MeshPhongMaterial({map:THREE.ImageUtils.loadTexture(d)});b.material=p}e.add(f)})};