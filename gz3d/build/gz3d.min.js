var GZ3D=GZ3D||{REVISION:"1"},guiEvents=new EventEmitter2({verbose:!0});$(function(){$("#toolbar-shapes").buttonset(),$("#toolbar-manipulate").buttonset(),$("#arrow").button({text:!1,icons:{primary:"toolbar-arrow"}}).click(function(){guiEvents.emit("manipulation_mode","view")}),$("#translate").button({text:!1,icons:{primary:"toolbar-translate"}}).click(function(){guiEvents.emit("manipulation_mode","translate")}),$("#rotate").button({text:!1,icons:{primary:"toolbar-rotate"}}).click(function(){guiEvents.emit("manipulation_mode","rotate")}),$("#box").button({text:!1,icons:{primary:"toolbar-box"}}).click(function(){guiEvents.emit("entity_create","box")}),$("#sphere").button({text:!1,icons:{primary:"toolbar-sphere"}}).click(function(){guiEvents.emit("entity_create","sphere")}),$("#cylinder").button({text:!1,icons:{primary:"toolbar-cylinder"}}).click(function(){guiEvents.emit("entity_create","cylinder")}),$("#play").button({text:!1,icons:{primary:"ui-icon-play"}}).click(function(){"Play"===$(this).text()?guiEvents.emit("pause",!1):guiEvents.emit("pause",!0)})}),$(function(){$("#menu").menu(),$("#reset-model").click(function(){guiEvents.emit("model_reset")}),$("#reset-world").click(function(){guiEvents.emit("world_reset")}),$("#view-collisions").click(function(){guiEvents.emit("show_collision")})}),GZ3D.Gui=function(a){this.scene=a,this.domElement=a.getDomElement(),this.init(),this.emitter=new EventEmitter2({verbose:!0})},GZ3D.Gui.prototype.init=function(){this.spawnModel=new GZ3D.SpawnModel(this.scene,this.scene.getDomElement());var a=this;guiEvents.on("entity_create",function(b){a.spawnModel.start(b,function(c){a.emitter.emit("entityCreated",c,b)})}),guiEvents.on("world_reset",function(){a.emitter.emit("reset","world")}),guiEvents.on("model_reset",function(){a.emitter.emit("reset","model")}),guiEvents.on("pause",function(b){a.emitter.emit("pause",b)}),guiEvents.on("manipulation_mode",function(b){a.scene.setManipulationMode(b)}),guiEvents.on("show_collision",function(){a.scene.showCollision(!a.scene.showCollisions)})},GZ3D.Gui.prototype.setPaused=function(a){var b;b=a?{label:"Play",icons:{primary:"ui-icon-play"}}:{label:"Pause",icons:{primary:"ui-icon-pause"}},$("#play").button("option",b)},GZ3D.Gui.prototype.setRealTime=function(a){$("#real-time-value").text(a)},GZ3D.Gui.prototype.setSimTime=function(a){$("#sim-time-value").text(a)},GZ3D.GZIface=function(a,b){this.scene=a,this.gui=b,this.init(),this.visualsToAdd=[]},GZ3D.GZIface.prototype.init=function(){this.material=[],this.entityMaterial={},this.webSocket=new ROSLIB.Ros({url:"ws://"+location.hostname+":7681"}),this.heartbeatTopic=new ROSLIB.Topic({ros:this.webSocket,name:"~/heartbeat",messageType:"heartbeat"});var a=this,b=function(){var b={alive:1};a.heartbeatTopic.publish(b)};setInterval(b,5e3);var c=new ROSLIB.Topic({ros:this.webSocket,name:"~/material",messageType:"material"}),d=function(a){this.material=a};c.subscribe(d.bind(this)),this.sceneTopic=new ROSLIB.Topic({ros:this.webSocket,name:"~/scene",messageType:"scene"});var e=function(a){a.name&&(this.scene.name=a.name),a.grid===!0&&this.scene.createGrid();for(var b=0;b<a.light.length;++b){var c=a.light[b],d=this.createLightFromMsg(c);this.scene.add(d)}for(var e=0;e<a.model.length;++e){var f=a.model[e],g=this.createModelFromMsg(f);this.scene.add(g)}this.sceneTopic.unsubscribe()};this.sceneTopic.subscribe(e.bind(this));var f=new ROSLIB.Topic({ros:this.webSocket,name:"~/pose/info",messageType:"pose"}),g=function(a){var b=this.scene.getByName(a.name);b&&this.scene.updatePose(b,a.position,a.orientation)};f.subscribe(g.bind(this));var h=new ROSLIB.Topic({ros:this.webSocket,name:"~/request",messageType:"request"}),i=function(a){if("entity_delete"===a.request){var b=this.scene.getByName(a.data);b&&this.scene.remove(b)}};h.subscribe(i.bind(this));var j=new ROSLIB.Topic({ros:this.webSocket,name:"~/model/info",messageType:"model"}),k=function(a){if(!this.scene.getByName(a.name)){var b=this.createModelFromMsg(a);b&&this.scene.add(b);for(var c=this.visualsToAdd.length,d=0,e=0;c>d;){var f=this.visualsToAdd[e].parent_name;f.indexOf(b.name)>=0?(this.createVisualFromMsg(this.visualsToAdd[e]),this.visualsToAdd.splice(e,1)):e++,d++}}};j.subscribe(k.bind(this));var l=new ROSLIB.Topic({ros:this.webSocket,name:"~/visual",messageType:"visual"}),m=function(a){if(!this.scene.getByName(a.name)){if(a.name.indexOf("COLLISION_VISUAL")<0)return;a.parent_name&&!this.scene.getByName(a.parent_name)?this.visualsToAdd.push(a):this.createVisualFromMsg(a)}};l.subscribe(m.bind(this));var n=new ROSLIB.Topic({ros:this.webSocket,name:"~/world_stats",messageType:"world_stats"}),o=function(a){this.updateStatsGuiFromMsg(a)};n.subscribe(o.bind(this));var p=new ROSLIB.Topic({ros:this.webSocket,name:"~/light",messageType:"light"}),q=function(a){if(!this.scene.getByName(a.name)){var b=this.createLightFromMsg(a);this.scene.add(b)}};p.subscribe(q.bind(this)),this.heightmapDataService=new ROSLIB.Service({ros:this.webSocket,name:"~/heightmap_data",serviceType:"heightmap_data"}),this.roadService=new ROSLIB.Service({ros:this.webSocket,name:"~/roads",serviceType:"roads"});var r=new ROSLIB.ServiceRequest({name:"roads"});this.roadService.callService(r,function(b){var c=a.createRoadsFromMsg(b);this.scene.add(c)}),this.modelModifyTopic=new ROSLIB.Topic({ros:this.webSocket,name:"~/model/modify",messageType:"model"});var s=function(b){var c=b.matrixWorld,d=new THREE.Vector3,e=new THREE.Quaternion,f=new THREE.Vector3;c.decompose(d,e,f);var g={name:b.name,id:b.userData,position:{x:d.x,y:d.y,z:d.z},orientation:{w:e.w,x:e.x,y:e.y,z:e.z}};a.modelModifyTopic.publish(g)};this.scene.emitter.on("poseChanged",s),this.factoryTopic=new ROSLIB.Topic({ros:this.webSocket,name:"~/factory",messageType:"factory"});var t=function(b,c){var d=b.matrixWorld,e=new THREE.Vector3,f=new THREE.Quaternion,g=new THREE.Vector3;d.decompose(e,f,g);var h={name:b.name,type:c,position:{x:e.x,y:e.y,z:e.z},orientation:{w:f.w,x:f.x,y:f.y,z:f.z}};a.factoryTopic.publish(h)};this.worldControlTopic=new ROSLIB.Topic({ros:this.webSocket,name:"~/world_control",messageType:"world_control"});var u=function(b,c){var d={};null!==b&&(d.pause=b),c&&(d.reset=c),a.worldControlTopic.publish(d)};this.scene.emitter.on("poseChanged",s),this.gui.emitter.on("entityCreated",t),this.gui.emitter.on("reset",function(a){u(null,a)}),this.gui.emitter.on("pause",function(a){u(a,null)})},GZ3D.GZIface.prototype.updateStatsGuiFromMsg=function(a){this.gui.setPaused(a.paused);var b=a.sim_time.sec,c=a.sim_time.nsec,d=Math.floor(b/86400);b-=86400*d;var e=Math.floor(b/3600);b-=3600*e;var f=Math.floor(b/60);b-=60*f;var g=(Math.floor(1e-6*c),a.real_time.sec),h=a.real_time.nsec,i=Math.floor(g/86400);g-=86400*i;var j=Math.floor(g/3600);g-=3600*j;var k=Math.floor(g/60);g-=60*k;var l=(Math.floor(1e-6*h),""),m="";10>i&&(m+="0"),m+=i.toFixed(0)+" ",10>j&&(m+="0"),m+=j.toFixed(0)+":",10>k&&(m+="0"),m+=k.toFixed(0)+":",10>g&&(m+="0"),m+=g.toFixed(0),10>d&&(l+="0"),l+=d.toFixed(0)+" ",10>e&&(l+="0"),l+=e.toFixed(0)+":",10>f&&(l+="0"),l+=f.toFixed(0)+":",10>b&&(l+="0"),l+=b.toFixed(0),this.gui.setRealTime(m),this.gui.setSimTime(l)},GZ3D.GZIface.prototype.createModelFromMsg=function(a){var b=new THREE.Object3D;b.name=a.name,b.userData=a.id,a.pose&&this.scene.setPose(b,a.pose.position,a.pose.orientation);for(var c=0;c<a.link.length;++c){var d=a.link[c],e=new THREE.Object3D;e.name=d.name,e.userData=d.id,d.pose&&this.scene.setPose(e,d.pose.position,d.pose.orientation),b.add(e);for(var f=0;f<d.visual.length;++f){var g=d.visual[f],h=this.createVisualFromMsg(g);h&&!h.parent&&e.add(h)}for(var i=0;i<d.collision.length;++i)for(var j=(d.collision[i],0);j<d.collision[i].visual.length;++j){var k=d.collision[i].visual[j],l=this.createVisualFromMsg(k);l&&!l.parent&&e.add(l)}}return b},GZ3D.GZIface.prototype.createVisualFromMsg=function(a){if(a.geometry){var b=a.geometry,c=new THREE.Object3D;return c.name=a.name,a.pose&&this.scene.setPose(c,a.pose.position,a.pose.orientation),c.castShadow=a.cast_shadows,c.receiveShadow=a.receive_shadows,this.createGeom(b,a.material,c),c}},GZ3D.GZIface.prototype.createLightFromMsg=function(a){var b,c=new THREE.Color;if(c.r=a.diffuse.r,c.g=a.diffuse.g,c.b=a.diffuse.b,1===a.type&&(b=new THREE.AmbientLight(c.getHex()),b.distance=a.range,this.scene.setPose(b,a.pose.position,a.pose.orientation)),2===a.type)b=new THREE.SpotLight(c.getHex()),b.distance=a.range,this.scene.setPose(b,a.pose.position,a.pose.orientation);else if(3===a.type){b=new THREE.DirectionalLight(c.getHex());var d=new THREE.Vector3(a.direction.x,a.direction.y,a.direction.z),e=d,f=d.negate();f.normalize();var g=10;a.pose.position.x+=g*f.x,a.pose.position.y+=g*f.y,a.pose.position.z+=g*f.z,e.x-=a.pose.position.x,e.y-=a.pose.position.y,e.z-=a.pose.position.z,b.target.position=e,b.shadowCameraNear=1,b.shadowCameraFar=50,b.shadowMapWidth=4094,b.shadowMapHeight=4094,b.shadowCameraVisible=!1,b.shadowCameraBottom=-100,b.shadowCameraLeft=-100,b.shadowCameraRight=100,b.shadowCameraTop=100,b.shadowBias=1e-4,b.position.set(f.x,f.y,f.z),this.scene.setPose(b,a.pose.position,a.pose.orientation)}return b.intensity=a.attenuation_constant,b.castShadow=a.cast_shadows,b.shadowDarkness=.3,b.name=a.name,b},GZ3D.GZIface.prototype.createRoadsFromMsg=function(a){var b=new THREE.Object3D,c=this.material["Gazebo/Road"],d=null;c&&(d=this.parseUri("media/materials/textures/"+c.texture));var e=this.scene.createRoads(a.point,a.width,d);return b.add(e),b},GZ3D.GZIface.prototype.parseUri=function(a){var b="assets",c=a.indexOf("://");return c>0&&(c+=3),b+"/"+a.substring(c)},GZ3D.GZIface.prototype.createGeom=function(a,b,c){function d(a){var b=[];a.getDescendants(b);for(var c=0;c<b.length;++c)if(b[c]instanceof THREE.Mesh){b[c].castShadow=!0,b[c].receiveShadow=!0,a.castShadows&&(b[c].castShadow=a.castShadows),a.receiveShadows&&(b[c].receiveShadow=a.receiveShadows),a.name.indexOf("COLLISION_VISUAL")>=0&&(b[c].castShadow=!1,b[c].receiveShadow=!1,b[c].visible=this.scene.showCollisions);break}}var e,f="assets",g=this,h=this.parseMaterial(b);if(a.box)e=this.scene.createBox(a.box.size.x,a.box.size.y,a.box.size.z);else if(a.cylinder)e=this.scene.createCylinder(a.cylinder.radius,a.cylinder.length);else if(a.sphere)e=this.scene.createSphere(a.sphere.radius);else if(a.plane)e=this.scene.createPlane(a.plane.normal.x,a.plane.normal.y,a.plane.normal.z,a.plane.size.x,a.plane.size.y);else if(a.mesh){for(var i=c;i.parent;)i=i.parent;var j=a.mesh.filename,k=a.mesh.submesh,l=a.mesh.center_submesh;console.log(a.mesh.filename+" "+k);var m=j.substring(0,j.indexOf("://"));if("file"===m||"model"===m){var n=j.substring(j.indexOf("://")+3);a.mesh.scale&&(c.scale.x=a.mesh.scale.x,c.scale.y=a.mesh.scale.y,c.scale.z=a.mesh.scale.z);var o=f+"/"+n,p=c.name+"::"+o;this.entityMaterial[p]=h,this.scene.loadMesh(o,k,l,function(a){if(g.entityMaterial[p]){var b=[];a.getDescendants(b);for(var e=0;e<b.length;++e)if(b[e]instanceof THREE.Mesh){g.scene.setMaterial(b[e],g.entityMaterial[p]);break}}c.add(a),d(c)})}}else if(a.heightmap){for(var q=new ROSLIB.ServiceRequest({name:g.scene.name}),r=a.heightmap.texture,s=0;s<r.length;++s)r[s].diffuse=this.parseUri(r[s].diffuse),r[s].normal=this.parseUri(r[s].normal);{a.heightmap.size}this.heightmapDataService.callService(q,function(b){var d=b.heightmap;g.scene.loadHeightmap(d.heights,d.size.x,d.size.y,d.width,d.height,d.origin,r,a.heightmap.blend,c)})}e&&(h&&(this.scene.setMaterial(e,h),e.updateMatrix(),c.add(e)),d(c))},GZ3D.GZIface.prototype.applyMaterial=function(a,b){if(a&&b){a.material=new THREE.MeshPhongMaterial;var c=b.ambient;c&&a.material.ambient.setRGB(c[0],c[1],c[2]);var d=b.diffuse;d&&a.material.color.setRGB(d[0],d[1],d[2]);var e=b.specular;e&&a.material.specular.setRGB(e[0],e[1],e[2]);var f=b.opacity;f&&1>f&&(a.material.transparent=!0,a.material.opacity=f),b.texture&&(a.material.map=THREE.ImageUtils.loadTexture(b.texture)),b.normalMap&&(a.material.normalMap=THREE.ImageUtils.loadTexture(b.normalMap))}},GZ3D.GZIface.prototype.parseMaterial=function(a){if(!a)return null;var b,c,d,e,f,g,h,i,j="assets",k=a.script;if(k&&k.uri.length>0&&k.name&&(i=this.material[k.name])){e=i.ambient,f=i.diffuse,g=i.specular,h=i.opacity;var l=i.texture;if(l){for(var m=0;m<k.uri.length;++m){var n=k.uri[m].substring(0,k.uri[m].indexOf("://"));if("model"===n){if(k.uri[m].indexOf("textures")>0){d=k.uri[m].substring(k.uri[m].indexOf("://")+3);break}}else if("file"===n&&k.uri[m].indexOf("materials")>0){d=k.uri[m].substring(k.uri[m].indexOf("://")+3,k.uri[m].indexOf("materials")+9)+"/textures";break}}d&&(b=j+"/"+d+"/"+l)}}if(a.normal_map){var o;if(o=a.normal_map.indexOf("://")>0?a.normal_map.substring(a.normal_map.indexOf("://")+3,a.normal_map.lastIndexOf("/")):d){var p=a.normal_map.lastIndexOf("/")+1;0>p&&(p=0);var q=a.normal_map.substr(p,a.normal_map.lastIndexOf(".")-p);c=j+"/"+o+"/"+q+".png"}}return{texture:b,normalMap:c,ambient:e,diffuse:f,specular:g,opacity:h}},GZ3D.Scene=function(){this.init()},GZ3D.Scene.prototype.init=function(){this.name="default",this.scene=new THREE.Scene,this.meshes={},this.heightmap=null,this.selectedEntity=null,this.mouseEntity=null,this.manipulationMode="view",this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.setClearColor(13421772,1),this.renderer.setSize(window.innerWidth,window.innerHeight),this.ambient=new THREE.AmbientLight(2236962),this.scene.add(this.ambient),this.camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.1,1e3),this.camera.position.x=0,this.camera.position.y=-5,this.camera.position.z=5,this.camera.up=new THREE.Vector3(0,0,1),this.camera.lookAt(0,0,0),this.showCollisions=!1;var a=this;this.getDomElement().addEventListener("mousedown",function(b){a.onMouseDown(b)},!1),document.addEventListener("mouseup",function(b){a.onMouseUp(b)},!1),this.getDomElement().addEventListener("mouseup",function(b){a.onMouseUp(b)},!1),this.getDomElement().addEventListener("DOMMouseScroll",function(b){a.onMouseScroll(b)},!1),this.getDomElement().addEventListener("mousewheel",function(b){a.onMouseScroll(b)},!1),document.addEventListener("keydown",function(b){a.onKeyDown(b)},!1),this.modelManipulator=new THREE.TransformControls(this.camera,this.getDomElement()),this.controls=new THREE.OrbitControls(this.camera),this.emitter=new EventEmitter2({verbose:!0}),this.effectsEnabled=!1;var b=THREE.ShaderLib.depthRGBA,c=THREE.UniformsUtils.clone(b.uniforms);this.depthMaterial=new THREE.ShaderMaterial({fragmentShader:b.fragmentShader,vertexShader:b.vertexShader,uniforms:c}),this.depthMaterial.blending=THREE.NoBlending,this.composer=new THREE.EffectComposer(this.renderer),this.composer.addPass(new THREE.RenderPass(this.scene,this.camera)),this.depthTarget=new THREE.WebGLRenderTarget(window.innerWidth,window.innerHeight,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat});var d=new THREE.ShaderPass(THREE.SSAOShader);d.uniforms.tDepth.value=this.depthTarget,d.uniforms.size.value.set(window.innerWidth,window.innerHeight),d.uniforms.cameraNear.value=this.camera.near,d.uniforms.cameraFar.value=this.camera.far,d.renderToScreen=!0,this.composer.addPass(d)},GZ3D.Scene.prototype.onMouseDown=function(a){a.preventDefault(),this.controls.enabled=!0;var b=new THREE.Vector2(a.clientX,a.clientY),c=new THREE.Vector3,d=this.getRayCastModel(b,c);c&&(this.controls.target=c),"view"!==this.manipulationMode&&(d?"plane"===d.name?this.killCameraControl=!1:""!==d.name?(this.modelManipulator.attach(d),this.modelManipulator.mode=this.manipulationMode,this.modelManipulator.setMode(this.modelManipulator.mode),this.selectedEntity=d,this.mouseEntity=this.selectedEntity,this.scene.add(this.modelManipulator.gizmo),this.killCameraControl=!0):this.modelManipulator.hovered?(this.modelManipulator.update(),this.modelManipulator.object.updateMatrixWorld(),this.mouseEntity=this.selectedEntity,this.killCameraControl=!0):this.killCameraControl=!1:(this.modelManipulator.detach(),this.scene.remove(this.modelManipulator.gizmo),this.killCameraControl=!1,this.selectedEntity=null))},GZ3D.Scene.prototype.onMouseUp=function(a){a.preventDefault(),this.controls.enabled=!0,this.modelManipulator.hovered&&this.selectedEntity?this.emitter.emit("poseChanged",this.modelManipulator.object):this.killCameraControl&&(this.killCameraControl=!1),this.mouseEntity=null},GZ3D.Scene.prototype.onMouseScroll=function(a){a.preventDefault(),this.controls.enabled=!0;{var b=new THREE.Vector2(a.clientX,a.clientY),c=new THREE.Vector3;this.getRayCastModel(b,c)}c&&(this.controls.target=c)},GZ3D.Scene.prototype.onKeyDown=function(a){if(a.shiftKey&&(187===a.keyCode||189===a.keyCode)){this.controls.enabled=!0;{var b=new THREE.Vector2(window.innerWidth/2,window.innerHeight/2),c=new THREE.Vector3;this.getRayCastModel(b,c)}c&&(this.controls.target=c),187===a.keyCode?this.controls.dollyOut():this.controls.dollyIn()}113===a.keyCode&&(this.effectsEnabled=!this.effectsEnabled)},GZ3D.Scene.prototype.getRayCastModel=function(a,b){var c=new THREE.Projector,d=new THREE.Vector3((a.x-this.renderer.domElement.offsetLeft)/window.innerWidth*2-1,2*-((a.y-this.renderer.domElement.offsetTop)/window.innerHeight)+1,1);c.unprojectVector(d,this.camera);var e=new THREE.Raycaster(this.camera.position,d.sub(this.camera.position).normalize()),f=[];this.scene.getDescendants(f);var g,h,i=e.intersectObjects(f);if(i.length>0)for(var j=0;j<i.length;++j){if(g=i[j].object,!this.modelManipulator.hovered&&"plane"===i[j].object.name){h=i[j].point;break}if("grid"!==i[j].object.name){for(;g.parent!==this.scene;)g=g.parent;if(g.name.indexOf("COLLISION_VISUAL")>=0)g=null;else if(this.modelManipulator.hovered){if(g===this.modelManipulator.gizmo)break}else if(""!==g.name){h=i[j].point;break}}else g=null}return h&&(b.x=h.x,b.y=h.y,b.z=h.z),g},GZ3D.Scene.prototype.getDomElement=function(){return this.renderer.domElement},GZ3D.Scene.prototype.render=function(){this.killCameraControl?this.controls.enabled=!1:(this.controls.enabled=!0,this.controls.update()),this.modelManipulator.update(),this.effectsEnabled?(this.scene.overrideMaterial=this.depthMaterial,this.renderer.render(this.scene,this.camera,this.depthTarget),this.scene.overrideMaterial=null,this.composer.render()):this.renderer.render(this.scene,this.camera)},GZ3D.Scene.prototype.setWindowSize=function(a,b){this.camera.aspect=a/b,this.camera.updateProjectionMatrix(),this.renderer.setSize(a,b),this.render()},GZ3D.Scene.prototype.add=function(a){this.scene.add(a)},GZ3D.Scene.prototype.remove=function(a){this.scene.remove(a)},GZ3D.Scene.prototype.getByName=function(a){return this.scene.getObjectByName(a,!0)},GZ3D.Scene.prototype.updatePose=function(a,b,c){this.modelManipulator&&this.modelManipulator.object&&this.modelManipulator.hovered&&this.mouseEntity||this.setPose(a,b,c)},GZ3D.Scene.prototype.setPose=function(a,b,c){a.position.x=b.x,a.position.y=b.y,a.position.z=b.z,a.quaternion.w=c.w,a.quaternion.x=c.x,a.quaternion.y=c.y,a.quaternion.z=c.z},GZ3D.Scene.prototype.createGrid=function(){var a=new THREE.GridHelper(10,1);a.name="grid",a.position.z=.05,a.rotation.x=.5*Math.PI,a.castShadow=!1,this.scene.add(a)},GZ3D.Scene.prototype.createPlane=function(a,b,c,d,e){var f=new THREE.PlaneGeometry(d,e,1,1),g=new THREE.MeshPhongMaterial({color:12303291,shading:THREE.SmoothShading}),h=new THREE.Mesh(f,g),i=new THREE.Vector3(a,b,c),j=i.crossVectors(i,h.up);return h.rotation=i.applyAxisAngle(j,-i.angleTo(h.up)),h.name="plane",h.receiveShadow=!0,h},GZ3D.Scene.prototype.createSphere=function(a){var b=new THREE.SphereGeometry(a,32,32),c=new THREE.MeshPhongMaterial({color:16777215,shading:THREE.SmoothShading}),d=new THREE.Mesh(b,c);return d},GZ3D.Scene.prototype.createCylinder=function(a,b){var c=new THREE.CylinderGeometry(a,a,b,32,1,!1),d=new THREE.MeshPhongMaterial({color:16777215,shading:THREE.SmoothShading}),e=new THREE.Mesh(c,d);return e.rotation.x=.5*Math.PI,e},GZ3D.Scene.prototype.createBox=function(a,b,c){var d=new THREE.CubeGeometry(a,b,c,1,1,1);d.dynamic=!0;for(var e=[1,4,5],f=[0],g=0;g<e.length;++g){var h=2*e[g],i=d.faceVertexUvs[0][h][0];d.faceVertexUvs[0][h][0]=d.faceVertexUvs[0][h][1],d.faceVertexUvs[0][h][1]=d.faceVertexUvs[0][h+1][1],d.faceVertexUvs[0][h][2]=i,d.faceVertexUvs[0][h+1][0]=d.faceVertexUvs[0][h+1][1],d.faceVertexUvs[0][h+1][1]=d.faceVertexUvs[0][h+1][2],d.faceVertexUvs[0][h+1][2]=d.faceVertexUvs[0][h][2]}for(var j=0;j<f.length;++j){var k=2*f[j],l=d.faceVertexUvs[0][k][0];d.faceVertexUvs[0][k][0]=d.faceVertexUvs[0][k][2],d.faceVertexUvs[0][k][1]=l,d.faceVertexUvs[0][k][2]=d.faceVertexUvs[0][k+1][1],d.faceVertexUvs[0][k+1][2]=d.faceVertexUvs[0][k][2],d.faceVertexUvs[0][k+1][1]=d.faceVertexUvs[0][k+1][0],d.faceVertexUvs[0][k+1][0]=d.faceVertexUvs[0][k][1]}d.uvsNeedUpdate=!0;var m=new THREE.MeshPhongMaterial({color:16777215,shading:THREE.SmoothShading}),n=new THREE.Mesh(d,m);return n.castShadow=!0,n},GZ3D.Scene.prototype.createRoads=function(a,b,c){var d=new THREE.Geometry;d.dynamic=!0;for(var e,f,g,h=0,i=b,j=1,k=0,l=new THREE.Vector3(0,0,0),m=new THREE.Vector3(0,0,0),n=[],o=0,p=0;p<a.length;++p){var q,r=new THREE.Vector3(a[p].x,a[p].y,a[p].z);if(p!==a.length-1&&(q=new THREE.Vector3(a[p+1].x,a[p+1].y,a[p+1].z)),j=1,p>0&&(k+=r.distanceTo(m)),h=k/i,0===p)l.x=q.x,l.y=q.y,l.z=q.z,l.sub(r),l.normalize();else if(p===a.length-1)l.x=r.x,l.y=r.y,l.z=r.z,l.sub(m),l.normalize();else{var s=new THREE.Vector3(0,0,0),t=new THREE.Vector3(0,0,0);s.x=r.x,s.y=r.y,s.z=r.z,s.sub(m),s.normalize(),t.x=q.x,t.y=q.y,t.z=q.z,t.sub(r),t.normalize();var u=s.dot(-1*t);l.x=q.x,l.y=q.y,l.z=q.z,l.sub(m),l.normalize(),u>-.97&&.97>u&&(j=1/Math.sin(.5*Math.acos(u)))}var v=Math.atan2(l.x,-l.y);e=new THREE.Vector3(r.x,r.y,r.z),f=new THREE.Vector3(r.x,r.y,r.z);var w=b*j*.5;e.x+=Math.cos(v)*w,e.y+=Math.sin(v)*w,f.x-=Math.cos(v)*w,f.y-=Math.sin(v)*w,d.vertices.push(e),d.vertices.push(f),n.push([0,h]),n.push([1,h]),p>0&&(d.faces.push(new THREE.Face3(o,o+1,o+2,new THREE.Vector3(0,0,1))),d.faceVertexUvs[0].push([new THREE.Vector2(n[o][0],n[o][1]),new THREE.Vector2(n[o+1][0],n[o+1][1]),new THREE.Vector2(n[o+2][0],n[o+2][1])]),o++,d.faces.push(new THREE.Face3(o,o+2,o+1,new THREE.Vector3(0,0,1))),d.faceVertexUvs[0].push([new THREE.Vector2(n[o][0],n[o][1]),new THREE.Vector2(n[o+2][0],n[o+2][1]),new THREE.Vector2(n[o+1][0],n[o+1][1])]),o++),m.x=r.x,m.y=r.y,m.z=r.z,g=h}d.computeFaceNormals(),d.verticesNeedUpdate=!0,d.uvsNeedUpdate=!0;var x=new THREE.MeshPhongMaterial;if(c){var y=THREE.ImageUtils.loadTexture(c);y.wrapS=y.wrapT=THREE.RepeatWrapping,x.map=y}var z=new THREE.Mesh(d,x);return z.castShadow=!1,z},GZ3D.Scene.prototype.loadHeightmap=function(a,b,c,d,e,f,g,h,i){if(!this.heightmap){var j=1,k=256;d-1>k&&(j=k/(d-1));var l=new THREE.PlaneGeometry(b,c,(d-1)*j,(e-1)*j);l.dynamic=!0;for(var m=[],n=e-1;n>=0;--n)for(var o=0;d>o;++o)m[(e-n-1)*d+o]=a[n*d+o];for(var p=(d-1)*j,q=(e-1)*j,r=0;q>r;++r)for(var s=0;p>s;++s){var t=r*p*1/(j*j)+s*(1/j);l.vertices[r*p+s].z=m[t]}var u;if(g&&g.length>0){l.computeFaceNormals(),l.computeVertexNormals(),l.computeTangents();for(var v=[],w=[],x=0;x<g.length;++x)v[x]=THREE.ImageUtils.loadTexture(g[x].diffuse,new THREE.UVMapping),v[x].wrapS=THREE.RepeatWrapping,v[x].wrapT=THREE.RepeatWrapping,w[x]=b/g[x].size;for(var y=g.length;3>y;++y)v[y]=v[y-1];for(var z=h.length;2>y;++z)h[z]=h[z-1];for(var A=w.length;3>A;++A)w[A]=w[A-1];var B=new THREE.Vector3(0,0,1),C=new THREE.Color(16777215),D=[];this.scene.getDescendants(D);for(var E=0;E<D.length;++E)if(D[E]instanceof THREE.DirectionalLight){B=D[E].position,C=D[E].color;break}var F=new THREE.ShaderMaterial({uniforms:{texture0:{type:"t",value:v[0]},texture1:{type:"t",value:v[1]},texture2:{type:"t",value:v[2]},repeat0:{type:"f",value:w[0]},repeat1:{type:"f",value:w[1]},repeat2:{type:"f",value:w[2]},minHeight1:{type:"f",value:h[0].min_height},fadeDist1:{type:"f",value:h[0].fade_dist},minHeight2:{type:"f",value:h[1].min_height},fadeDist2:{type:"f",value:h[1].fade_dist},ambient:{type:"c",value:this.ambient.color},lightDiffuse:{type:"c",value:C},lightDir:{type:"v3",value:B}},attributes:{},vertexShader:document.getElementById("heightmapVS").innerHTML,fragmentShader:document.getElementById("heightmapFS").innerHTML});u=new THREE.Mesh(l,F)}else u=new THREE.Mesh(l,new THREE.MeshPhongMaterial({color:5592405}));u.position.x=f.x,u.position.y=f.y,u.position.z=f.z,i.add(u),this.heightmap=i}},GZ3D.Scene.prototype.loadMesh=function(a,b,c,d){var e=(a.substring(0,a.lastIndexOf("/")),a.substring(a.lastIndexOf("/")+1));return".dae"===e.substr(-4).toLowerCase()?this.loadCollada(a,b,c,d):(".urdf"===e.substr(-5).toLowerCase(),void 0)},GZ3D.Scene.prototype.loadCollada=function(a,b,c,d){var e,f=null;if(this.meshes[a]&&(e=this.meshes[a],f=b?this.prepareColladaMesh(e,b,c):this.prepareColladaMesh(e,null,null),d(e)),!f){var g=new THREE.ColladaLoader,h=a,i=b;g.load(a,function(b){e=b.scene,e.updateMatrix(),this.scene.meshes[h]=e,f=this.scene.prepareColladaMesh(e,i,c),e.name=a,d(e)})}},GZ3D.Scene.prototype.prepareColladaMesh=function(a,b,c){var d,e=[];a.getDescendants(e);for(var f=0;f<e.length;++f)if(e[f]instanceof THREE.Mesh){if(b||d||(d=e[f]),b)if(e[f].geometry.name===b){if(c){var g=e[f].geometry.vertices,h=new THREE.Vector3,i=new THREE.Vector3;h.x=g[0].x,h.y=g[0].y,h.z=g[0].z,i.x=h.x,i.y=h.y,i.z=h.z;for(var j=1;j<g.length;++j)h.x=Math.min(h.x,g[j].x),h.y=Math.min(h.y,g[j].y),h.z=Math.min(h.z,g[j].z),i.x=Math.max(i.x,g[j].x),i.y=Math.max(i.y,g[j].y),i.z=Math.max(i.z,g[j].z);var k=new THREE.Vector3;k.x=h.x+.5*(i.x-h.x),k.y=h.y+.5*(i.y-h.y),k.z=h.z+.5*(i.z-h.z);for(var l=0;l<g.length;++l)g[l].x-=k.x,g[l].y-=k.y,g[l].z-=k.z;e[f].geometry.verticesNeedUpdate=!0,e[f].position.x=0,e[f].position.y=0,e[f].position.z=0,e[f].parent.position.x=0,e[f].parent.position.y=0,e[f].parent.position.z=0}d=e[f]}else e[f].parent.remove(e[f])}else e[f]instanceof THREE.Light&&e[f].parent.remove(e[f]);return d},GZ3D.Scene.prototype.setMaterial=function(a,b){if(a&&b){a.material=new THREE.MeshPhongMaterial;var c=b.ambient;c&&a.material.ambient.setRGB(c[0],c[1],c[2]);var d=b.diffuse;d&&a.material.color.setRGB(d[0],d[1],d[2]);var e=b.specular;e&&a.material.specular.setRGB(e[0],e[1],e[2]);var f=b.opacity;f&&1>f&&(a.material.transparent=!0,a.material.opacity=f),b.texture&&(a.material.map=THREE.ImageUtils.loadTexture(b.texture)),b.normalMap&&(a.material.normalMap=THREE.ImageUtils.loadTexture(b.normalMap))}},GZ3D.Scene.prototype.setManipulationMode=function(a){"view"===a&&(this.killCameraControl=!1,this.modelManipulator.detach(),this.scene.remove(this.modelManipulator.gizmo)),this.manipulationMode=a,this.modelManipulator.mode=this.manipulationMode,this.modelManipulator.setMode(this.modelManipulator.mode)},GZ3D.Scene.prototype.showCollision=function(a){if(a!==this.showCollisions){var b=[];this.scene.getDescendants(b);for(var c=0;c<b.length;++c)if(b[c]instanceof THREE.Object3D&&b[c].name.indexOf("COLLISION_VISUAL")>=0){var d=[];b[c].getDescendants(d);for(var e=0;e<d.length;++e)d[e]instanceof THREE.Mesh&&(d[e].visible=a)}this.showCollisions=a}},GZ3D.SpawnModel=function(a,b){this.scene=a,this.domElement=void 0!==b?b:document,this.init(),this.obj=void 0,this.callback=void 0},GZ3D.SpawnModel.prototype.init=function(){this.plane=new THREE.Plane(new THREE.Vector3(0,0,1),0),this.projector=new THREE.Projector,this.ray=new THREE.Ray,this.obj=null,this.active=!1},GZ3D.SpawnModel.prototype.start=function(a,b){this.active&&this.finish(),this.callback=b,this.obj=new THREE.Object3D;var c;"box"===a?(c=this.scene.createBox(1,1,1),this.obj.name="unit_box_"+(new Date).getTime()):"sphere"===a?(c=this.scene.createSphere(.5),this.obj.name="unit_sphere_"+(new Date).getTime()):"cylinder"===a&&(c=this.scene.createCylinder(.5,1),this.obj.name="unit_cylinder_"+(new Date).getTime()),this.obj.add(c),this.obj.position.z+=.5,this.scene.add(this.obj);var d=this;this.domElement.addEventListener("mousedown",function(a){d.onMouseUp(a)},!1),this.domElement.addEventListener("mousemove",function(a){d.onMouseMove(a)},!1),document.addEventListener("keydown",function(a){d.onKeyDown(a)},!1),this.active=!0},GZ3D.SpawnModel.prototype.finish=function(){var a=this;this.domElement.removeEventListener("mousedown",function(b){a.onMouseUp(b)},!1),this.domElement.removeEventListener("mousemove",function(b){a.onMouseMove(b)},!1),document.removeEventListener("keydown",function(b){a.onKeyDown(b)},!1),this.scene.remove(this.obj),this.obj=void 0,this.active=!1},GZ3D.SpawnModel.prototype.onMouseDown=function(a){a.preventDefault()},GZ3D.SpawnModel.prototype.onMouseMove=function(a){if(this.active){a.preventDefault();var b=new THREE.Vector3(a.clientX/window.innerWidth*2-1,2*-(a.clientY/window.innerHeight)+1,.5);this.projector.unprojectVector(b,this.scene.camera),this.ray.set(this.scene.camera.position,b.sub(this.scene.camera.position).normalize());var c=this.ray.intersectPlane(this.plane);c.z=this.obj.position.z,this.scene.setPose(this.obj,c,new THREE.Quaternion)}},GZ3D.SpawnModel.prototype.onMouseUp=function(){this.active&&(this.callback(this.obj),this.finish())},GZ3D.SpawnModel.prototype.onKeyDown=function(a){27===a.keyCode&&this.finish()};